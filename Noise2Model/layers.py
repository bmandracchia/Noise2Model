# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/02_layers.ipynb.

# %% auto 0
__all__ = ['AffineSdn', 'Unconditional', 'Gain']

# %% ../nbs/02_layers.ipynb 4
from fastai.vision.all import nn, torch, np, Path, get_image_files, Image 
import normflows as nf
from .utils import attributesFromDict
# from Noise2Model.models import DnCNN, UNet
from .utils import gaussian_diag #, batch_PSNR, weights_init_orthogonal #, weights_init_kaiming


# %% ../nbs/02_layers.ipynb 12
from normflows.flows import GlowBlock, AffineConstFlow, Flow


# %% ../nbs/02_layers.ipynb 13
class AffineSdn(Flow):
    """
    Sdn flow layer
    """

    def __init__(self, shape):
        """Constructor

        
        """
        super().__init__()
        self.shape = shape

    def forward(self, z, **kwargs):
        y = kwargs['clean']
        y_, log_det = AffineConstFlow(self.shape)(y)
        return z * torch.sqrt(y_), log_det

    def inverse(self, z, **kwargs):
        y_, log_det = AffineConstFlow(self.shape)(y)
        return z / torch.sqrt(y_), log_det

# %% ../nbs/02_layers.ipynb 14
class Unconditional(Flow):
    """
    Unconditional flow layer
    """

    def __init__(self, channels, hidden_channels, split_mode):
        """Constructor

        
        """
        super().__init__()
        attributesFromDict(locals())

    def forward(self, z, **kwargs):
        return GlowBlock(channels=self.channels, hidden_channels = self.hidden_channels, split_mode=self.split_mode).forward(z)

    def inverse(self, z, **kwargs):
        return GlowBlock(channels=self.shape[0], hidden_channels = self.hidden_channels, split_mode=self.split_mode).inverse(z)

# %% ../nbs/02_layers.ipynb 15
class Gain(Flow):
    """
    Gain & Offset flow layer
    """

    def __init__(self, shape):
        """Constructor

        
        """
        super().__init__()
        self.shape = shape

    def forward(self, z, **kwargs):
        return AffineConstFlow(self.shape).forward(z)

    def inverse(self, z, **kwargs):
        return AffineConstFlow(self.shape).inverse(z)
